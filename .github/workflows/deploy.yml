name: Deploy Monorepo to Vercel

on:
  push:
    branches-ignore:
      - main
      - master
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

    steps:
      - name: 🧭 Checkout repo
        uses: actions/checkout@v4

      # ---------------- FRONTEND DEPLOY ----------------
      - name: 🚀 Deploy frontend to Vercel
        working-directory: frontend
        id: frontend
        run: |
          npm install -g vercel@latest
          npm install
          # deploy frontend and capture URL
          FRONTEND_URL=$(vercel deploy --yes --token=$VERCEL_TOKEN --confirm --cwd . | tail -n1)
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_ENV
          echo "Frontend deployed to: $FRONTEND_URL"

      # ---------------- BACKEND DEPLOY ----------------
      - name: 🚀 Deploy backend to Vercel
        working-directory: backend
        id: backend
        run: |
          npm install -g vercel@latest
          npm install
          # deploy backend and inject frontend URL
          BACKEND_URL=$(vercel deploy --yes --token=$VERCEL_TOKEN --confirm --env FRONTEND_URL=${{ env.frontend_url }} --cwd . | tail -n1)
          echo "backend_url=$BACKEND_URL" >> $GITHUB_ENV
          echo "Backend deployed to: $BACKEND_URL"

      # ---------------- UPDATE FRONTEND ENV VARS ----------------
      - name: 🔄 Update frontend env var with backend URL
        working-directory: frontend
        run: |
          echo $BACKEND_URL | xargs -I {} vercel env add REACT_APP_BACKEND_URL preview --token=$VERCEL_TOKEN --confirm

      # ---------------- OPTIONAL: COMMENT ON PR ----------------
      - name: 💬 Comment on PR with preview URLs
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            🚀 **Preview deployments are live!**
            - 🧩 Frontend: [${{ env.frontend_url }}](${{ env.frontend_url }})
            - ⚙️ Backend: [${{ env.backend_url }}](${{ env.backend_url }})
