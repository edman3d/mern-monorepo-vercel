name: Deploy Monorepo to Vercel (CRA + Express)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches-ignore:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

    steps:
      - name: ðŸ§­ Checkout repo
        uses: actions/checkout@v4

      # ---------------- BACKEND DEPLOY ----------------
      - name: ðŸš€ Deploy backend (runtime frontend URL optional)
        working-directory: backend
        id: backend
        run: |
          npm install -g vercel@latest
          npm install
          # You can optionally leave FRONTEND_URL empty or set a placeholder
          BACKEND_URL=$(vercel deploy --yes --token=$VERCEL_TOKEN --confirm --cwd . | tail -n1)
          echo "backend_url=$BACKEND_URL" >> $GITHUB_ENV
          echo "Backend preview URL: $BACKEND_URL"

      # ---------------- FRONTEND BUILD & DEPLOY ----------------
      - name: ðŸš€ Build & deploy frontend with backend URL
        working-directory: frontend
        run: |
          npm install -g vercel@latest
          npm install
          # Set CRA build-time env var so frontend knows backend
          export REACT_APP_BACKEND_URL=${{ env.backend_url }} npm run build
          FRONTEND_URL=$(vercel deploy --yes --token=$VERCEL_TOKEN --confirm --cwd . | tail -n1)
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_ENV
          echo "Frontend preview URL: $FRONTEND_URL"

      # ---------------- OPTIONAL: Update backend with frontend URL ----------------
      - name: ðŸ”„ Update backend runtime env with frontend URL
        working-directory: backend
        run: |
          # Only updates backend's runtime env; does NOT rebuild backend
          vercel env add FRONTEND_URL preview --token=$VERCEL_TOKEN --confirm <<< "${{ env.frontend_url }}"

      # ---------------- OPTIONAL: Comment on PR with preview URLs ----------------
      - name: ðŸ’¬ Comment on PR with preview URLs
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ðŸš€ **Preview deployments are live!**
            - âš™ï¸ Backend: [${{ env.backend_url }}](${{ env.backend_url }})
            - ðŸ§© Frontend: [${{ env.frontend_url }}](${{ env.frontend_url }})
