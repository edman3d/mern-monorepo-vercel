name: Deploy Monorepo to Vercel (CRA + Express)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches-ignore:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

    steps:
      - name: 🧭 Checkout repo
        uses: actions/checkout@v4

      # ---------------- FRONTEND PREVIEW DEPLOY ----------------
      - name: 🚀 Deploy frontend first (preview URL)
        working-directory: frontend
        id: frontend
        run: |
          npm install -g vercel@latest
          npm install
          FRONTEND_URL=$(vercel deploy --yes --token=$VERCEL_TOKEN --confirm --cwd . | tail -n1)
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_ENV
          echo "Frontend preview URL: $FRONTEND_URL"

      # ---------------- BACKEND PREVIEW DEPLOY ----------------
      - name: 🚀 Deploy backend with frontend URL
        working-directory: backend
        id: backend
        run: |
          npm install -g vercel@latest
          npm install
          # Inject frontend URL as runtime env for backend
          BACKEND_URL=$(vercel deploy --yes --token=$VERCEL_TOKEN --confirm --env FRONTEND_URL=${{ env.frontend_url }} --cwd . | tail -n1)
          echo "backend_url=$BACKEND_URL" >> $GITHUB_ENV
          echo "Backend preview URL: $BACKEND_URL"

      # ---------------- FRONTEND BUILD + DEPLOY WITH BACKEND ----------------
      - name: 🚀 Build & deploy frontend with backend URL
        working-directory: frontend
        run: |
          # Set CRA build-time env var before build
          export REACT_APP_BACKEND_URL=${{ env.backend_url }}
          npm install
          npm run build
          # Deploy built frontend
          vercel deploy --yes --token=$VERCEL_TOKEN --confirm --cwd .

      # ---------------- OPTIONAL: Comment on PR with preview URLs ----------------
      - name: 💬 Comment on PR with preview URLs
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            🚀 **Preview deployments are live!**
            - ⚙️ Backend: [${{ env.backend_url }}](${{ env.backend_url }})
            - 🧩 Frontend: [${{ env.frontend_url }}](${{ env.frontend_url }})
