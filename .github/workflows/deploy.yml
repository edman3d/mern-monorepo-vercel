name: Deploy Monorepo to Vercel (CRA + Express)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches-ignore:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ---------------- BACKEND DEPLOY ----------------
      - name: Deploy backend (capture preview URL)
        working-directory: backend
        id: backend
        run: |
          npm install -g vercel@latest
          npm install
          # Deploy backend first
          BACKEND_URL=$(vercel deploy --yes --token=$VERCEL_TOKEN --confirm --cwd . | tail -n1)
          echo "backend_url=$BACKEND_URL" >> $GITHUB_ENV
          echo "Backend preview URL: $BACKEND_URL"

      # ---------------- FRONTEND DEPLOY ----------------
      - name: Deploy frontend with backend URL
        working-directory: frontend
        id: frontend
        run: |
          npm install -g vercel@latest
          npm install
          # Deploy frontend to Vercel cloud, pass backend URL as env var
          FRONTEND_URL=$(vercel deploy --yes --token=$VERCEL_TOKEN --confirm --cwd . --env REACT_APP_BACKEND_URL=${{ env.backend_url }} | tail -n1)
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_ENV
          echo "Frontend preview URL: $FRONTEND_URL"

      # ---------------- OPTIONAL: Update backend runtime env ----------------
      - name: Update backend with frontend URL (runtime env)
        working-directory: backend
        run: |
          # Sets FRONTEND_URL for backend runtime usage (no rebuild needed)
          vercel env add FRONTEND_URL preview --token=$VERCEL_TOKEN --confirm <<< "${{ env.frontend_url }}"

      # ---------------- OPTIONAL: Comment on PR ----------------
      - name: Comment on PR with preview URLs
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ðŸš€ Preview deployments:
            - Backend: [${{ env.backend_url }}](${{ env.backend_url }})
            - Frontend: [${{ env.frontend_url }}](${{ env.frontend_url }})
